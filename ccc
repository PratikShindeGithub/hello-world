#!/bin/bash

SERVERS=(
"tbp-web@deccc3dr"
"tbp-web@deccc4dr"
"tbp-web@deptc3hr"
"tbp-web@deptc4hr"
"tbp-web@deptc5hr"
"tbp-web@deptc6hr"
)

LOG_DIR="/opt/web/tomcat/ccc/logs"

LOG_PATTERNS=(
"ccc-main.log*"
"ccc-exception.log*"
"access*.log*"
"stdout.log*"
)

GREEN="\e[32m"
RED="\e[31m"
YELLOW="\e[33m"
BLUE="\e[34m"
RESET="\e[0m"

clear
echo -e "${BLUE}========================================${RESET}"
echo -e "${BLUE}        CCC CENTRAL LOG TOOL             ${RESET}"
echo -e "${BLUE}========================================${RESET}"
echo ""
echo "1) Search keyword in all logs (incl gz)"
echo "2) Real-time live monitoring"
echo "3) Error summary"
echo "4) Exit"

read -p "Select option: " MODE

[[ "$MODE" == "4" ]] && exit 0

read -p "Enter keyword (not required for summary): " KEYWORD

build_cmd() {
  local CMD=""

  for PAT in "${LOG_PATTERNS[@]}"; do
    CMD+=" $LOG_DIR/$PAT"
  done

  echo "$CMD"
}

FILES=$(build_cmd)

search_logs() {
  SERVER=$1
  echo -e "${GREEN}===== $SERVER =====${RESET}"

  ssh "$SERVER" "
    cd $LOG_DIR || exit

    for f in $FILES; do
      if [[ \"\$f\" == *.gz ]]; then
        zgrep -in \"$KEYWORD\" \"\$f\" 2>/dev/null
      else
        grep -in \"$KEYWORD\" \"\$f\" 2>/dev/null
      fi
    done
  "
}

live_logs() {
  SERVER=$1
  echo -e "${GREEN}--- LIVE $SERVER ---${RESET}"

  ssh "$SERVER" "
    tail -F \
      $LOG_DIR/ccc-main.log* \
      $LOG_DIR/ccc-exception.log* \
      $LOG_DIR/stdout.log* 2>/dev/null
  " | sed "s/^/[$SERVER] /"
}

error_summary() {
  SERVER=$1
  echo -e "${YELLOW}--- $SERVER ---${RESET}"

  ssh "$SERVER" "
    cd $LOG_DIR || exit

    for f in *; do
      if [[ \"\$f\" == *.gz ]]; then
        zgrep -Ei 'ERROR|WARN|FATAL|EXCEPTION' \"\$f\"
      else
        grep -Ei 'ERROR|WARN|FATAL|EXCEPTION' \"\$f\"
      fi
    done | awk '
      /ERROR/ {e++}
      /WARN/ {w++}
      /FATAL/ {f++}
      /EXCEPTION/ {x++}
      END {print \"ERROR:\",e+0,\"WARN:\",w+0,\"FATAL:\",f+0,\"EXCEPTION:\",x+0}
    '
  "
}

case $MODE in
1)
  for SERVER in "${SERVERS[@]}"; do
    search_logs "$SERVER" &
  done
  wait
  ;;
2)
  echo -e "${RED}Press CTRL+C to stop live mode${RESET}"
  for SERVER in "${SERVERS[@]}"; do
    live_logs "$SERVER" &
  done
  wait
  ;;
3)
  echo -e "${BLUE}========= CCC ERROR SUMMARY =========${RESET}"
  for SERVER in "${SERVERS[@]}"; do
    error_summary "$SERVER"
  done
  ;;
esac
