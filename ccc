#!/bin/bash

SERVERS=(
tbp-web@deccc3dr
tbp-web@deccc4dr
tbp-web@deptc3hr
tbp-web@deptc4hr
tbp-web@deptc5hr
tbp-web@deptc6hr
)

LOG_DIR="/opt/web/tomcat/ccc/logs"
SSH_OPTS="-o BatchMode=yes"

EXPORT="ccc_export_$(date +%Y%m%d_%H%M%S).txt"

echo "=========== CCC LOG SEARCH ==========="
echo "1) Main logs"
echo "2) Exception logs"
echo "3) Access logs"
echo "4) Stdout logs"
read -p "Select log type: " TYPE

case $TYPE in
1) PREFIX="ccc-main.log"; FORMAT="HOUR" ;;
2) PREFIX="ccc-exception.log"; FORMAT="HOUR" ;;
3) PREFIX="access"; FORMAT="DATE" ;;
4) PREFIX="stdout.log"; FORMAT="DATE" ;;
*) echo "Invalid"; exit 1 ;;
esac

if [[ "$FORMAT" == "HOUR" ]]; then
  read -p "Enter timestamp (YYYYMMDDHH): " TS
  PATTERN="$PREFIX.$TS*"
else
  read -p "Enter date (YYYY-MM-DD): " TS
  PATTERN="$PREFIX.$TS.log*"
fi

read -p "Enter keyword: " KEYWORD

> "$EXPORT"
echo "LOG TYPE: $PREFIX  TIME: $TS" >> "$EXPORT"
echo "============================" >> "$EXPORT"

search_server() {
  SERVER=$1
  HOST=${SERVER#*@}

  ssh $SSH_OPTS "$SERVER" "
    cd $LOG_DIR || exit
    for f in $PATTERN; do
      [[ -e \$f ]] || continue
      if [[ \$f == *.gz ]]; then
        zgrep -in \"$KEYWORD\" \"\$f\"
      else
        grep -in \"$KEYWORD\" \"\$f\"
      fi
    done
  " | sed "s/^/[$HOST] /" | tee -a "$EXPORT"
}

for S in "${SERVERS[@]}"; do
  search_server "$S" &
done
wait

echo ""
echo "Exported to: $EXPORT"
