#!/bin/bash

SERVERS=(
"tbp-web@deccc3dr"
"tbp-web@deccc4dr"
"tbp-web@deptc3hr"
"tbp-web@deptc4hr"
"tbp-web@deptc5hr"
"tbp-web@deptc6hr"
)

LOG_DIR="/opt/web/tomcat/ccc/logs"

LOG_PATTERNS=(
"ccc-main.log*"
"ccc-exception.log*"
"access*.log*"
"stdout.log*"
)

SSH_OPTS="-o BatchMode=yes -o ConnectTimeout=5"

EXPORT_FILE="ccc_logs_$(date +%Y%m%d_%H%M%S).txt"

GREEN="\e[32m"
BLUE="\e[34m"
RED="\e[31m"
RESET="\e[0m"

clear
echo -e "${BLUE}========= CCC CENTRAL LOG TOOL =========${RESET}"
echo ""
echo "1) Search keyword (all logs + gz)"
echo "2) Real-time live logs"
echo "3) Exit"

read -p "Choose: " MODE
[[ "$MODE" == "3" ]] && exit 0

read -p "Enter keyword: " KEYWORD

touch "$EXPORT_FILE"

echo "CCC LOG EXPORT - $(date)" >> "$EXPORT_FILE"
echo "====================================" >> "$EXPORT_FILE"

search_server() {
  SERVER=$1
  HOST=${SERVER#*@}

  ssh $SSH_OPTS "$SERVER" "
    cd $LOG_DIR || exit
    for p in ${LOG_PATTERNS[@]}; do
      for f in \$p; do
        if [[ \"\$f\" == *.gz ]]; then
          zgrep -in \"$KEYWORD\" \"\$f\" 2>/dev/null
        else
          grep -in \"$KEYWORD\" \"\$f\" 2>/dev/null
        fi
      done
    done
  " | sed "s/^/[$HOST] /" | tee -a "$EXPORT_FILE"
}

live_server() {
  SERVER=$1
  HOST=${SERVER#*@}

  ssh $SSH_OPTS "$SERVER" "
    tail -F \
      $LOG_DIR/ccc-main.log* \
      $LOG_DIR/ccc-exception.log* \
      $LOG_DIR/stdout.log*
  " | sed "s/^/[$HOST] /"
}

if [[ "$MODE" == "1" ]]; then
  for SERVER in "${SERVERS[@]}"; do
    search_server "$SERVER" &
  done
  wait

  echo ""
  echo -e "${GREEN}Logs exported to:${RESET} $EXPORT_FILE"

elif [[ "$MODE" == "2" ]]; then
  echo -e "${RED}Live mode (not exported). Press CTRL+C to stop.${RESET}"
  for SERVER in "${SERVERS[@]}"; do
    live_server "$SERVER" &
  done
  wait
fi
